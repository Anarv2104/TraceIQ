name: Experiments

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      mode:
        description: "smoke or proof"
        default: "proof"
        type: choice
        options:
          - smoke
          - proof

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Create output directories
        run: mkdir -p experiments/results experiments/plots research/outputs

      - name: Lint check
        run: |
          ruff check src/traceiq tests experiments/topologies.py experiments/exp_*.py
          ruff format --check src/traceiq tests experiments/topologies.py experiments/exp_*.py

      - name: Run smoke validation
        run: |
          chmod +x scripts/run_validation.sh
          ./scripts/run_validation.sh smoke

      - name: Upload smoke results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results
          path: |
            experiments/results/**/summary.json
            research/outputs/**/summary.json

  proof:
    if: github.event_name == 'workflow_dispatch' && inputs.mode == 'proof'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[all,dev]"

      - name: Create output directories
        run: mkdir -p experiments/results experiments/plots research/outputs

      - name: Run proof validation
        run: |
          chmod +x scripts/run_validation.sh
          ./scripts/run_validation.sh proof

      - name: Upload proof results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proof-results
          path: |
            experiments/results/
            experiments/plots/
            research/outputs/
